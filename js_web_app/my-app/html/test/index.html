<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Cropper</title>
    <style>
        .content {
            display: inline-block;
            position: relative;
            margin: 20px;
        }

        .video-container {
            position: relative;
            display: inline-block;
        }

        .main-video {
            max-width: 100%;
            height: auto;
        }

        .floating-box {
            background-color: rgba(41, 238, 238, 0.1);
            border: 2px dashed #29e;
            color: white;
            font-size: 12px;
            font-family: sans-serif;
            border-radius: 4px;
            padding: 0;
            touch-action: none;
            user-select: none;
            width: 120px;
            height: 80px;
            box-sizing: border-box;
            position: absolute;
            top: 20px;
            left: 20px;
            cursor: move;
        }

        .preview-container {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            display: inline-block;
        }

        #preview-canvas {
            border: 1px solid #29e;
        }
    </style>
</head>
<body>
    <section class="content">
        <div class="video-container">
            <video id="main-video" class="main-video" controls>
                <source src="https://live-par-2-abr.livepush.io/vod/bigbuckbunnyclip.mp4" type="video/mp4">
                Video not supported.
            </video>
            <div id="crop-box" class="floating-box"></div>
        </div>
        
        <div class="preview-container">
            <h3>Preview</h3>
            <canvas id="preview-canvas"></canvas>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script>
        const video = document.getElementById('main-video');
        const cropBox = document.getElementById('crop-box');
        const previewCanvas = document.getElementById('preview-canvas');
        const ctx = previewCanvas.getContext('2d');

        // Set initial preview canvas size
        previewCanvas.width = 320;
        previewCanvas.height = 180;

        function updatePreview() {
            if (video.paused || video.ended) return;

            const rect = cropBox.getBoundingClientRect();
            const videoRect = video.getBoundingClientRect();
            
            // Calculate relative position
            const x = rect.left - videoRect.left;
            const y = rect.top - videoRect.top;
            
            // Calculate scale factor between video's natural size and displayed size
            const scaleX = video.videoWidth / videoRect.width;
            const scaleY = video.videoHeight / videoRect.height;
            
            // Clear the preview canvas
            ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
            
            // Draw the cropped portion of the video
            try {
                ctx.drawImage(
                    video,
                    x * scaleX,
                    y * scaleY,
                    rect.width * scaleX,
                    rect.height * scaleY,
                    0,
                    0,
                    previewCanvas.width,
                    previewCanvas.height
                );
            } catch (e) {
                console.error('Error drawing video frame:', e);
            }
            
            requestAnimationFrame(updatePreview);
        }

        // Start preview when video plays
        video.addEventListener('play', () => {
            updatePreview();
        });

        // Make the crop box draggable and resizable
        interact('.floating-box')
            .draggable({
                inertia: true,
                modifiers: [
                    interact.modifiers.restrict({
                        restriction: 'parent',
                        elementRect: { top: 0, left: 0, bottom: 1, right: 1 }
                    })
                ],
                listeners: {
                    move: dragMoveListener
                }
            })
            .resizable({
                edges: { left: true, right: true, bottom: true, top: true },
                modifiers: [
                    interact.modifiers.restrictEdges({
                        outer: 'parent'
                    }),
                    interact.modifiers.restrictSize({
                        min: { width: 100, height: 50 }
                    })
                ],
                inertia: true,
                listeners: {
                    move: resizeMoveListener
                }
            });

        function dragMoveListener(event) {
            const target = event.target;
            const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
            const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

            target.style.transform = `translate(${x}px, ${y}px)`;
            target.setAttribute('data-x', x);
            target.setAttribute('data-y', y);
        }

        function resizeMoveListener(event) {
            const target = event.target;
            let x = (parseFloat(target.getAttribute('data-x')) || 0);
            let y = (parseFloat(target.getAttribute('data-y')) || 0);

            target.style.width = event.rect.width + 'px';
            target.style.height = event.rect.height + 'px';

            x += event.deltaRect.left;
            y += event.deltaRect.top;

            target.style.transform = `translate(${x}px, ${y}px)`;
            target.setAttribute('data-x', x);
            target.setAttribute('data-y', y);
        }
    </script>
</body>
</html>